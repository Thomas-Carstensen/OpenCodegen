import type {CodegenConfig} from '../config/schema.js';

/**
 * Generate the base client file containing BaseClient, ApiConfig, and ApiError.
 */
export const generateBase = (config: CodegenConfig): string => {
  const suffix = config.clientSuffix ?? 'Client';

  const lines: string[] = [
    '// Generated by OpenCodegen - do not edit manually',
    '',
    '/**',
    ' * Headers can be static, a sync function, or an async function.',
    ' */',
    'export type HeadersInit =',
    '  | Record<string, string>',
    '  | (() => Record<string, string>)',
    '  | (() => Promise<Record<string, string>>);',
    '',
    '/**',
    ' * Configuration for API clients.',
    ' */',
    'export interface ApiConfig {',
    '  /** Base URL for all API requests (e.g., "https://api.example.com") */',
    '  baseUrl: string;',
    '  /**',
    '   * Default headers to include with every request.',
    '   * Can be a static object, a sync function, or an async function.',
    '   *',
    '   * @example',
    '   * // Static headers',
    "   * headers: { 'X-Api-Key': 'abc' }",
    '   *',
    '   * @example',
    '   * // Dynamic headers (async)',
    '   * headers: async () => ({',
    "   *   'Authorization': `Bearer ${await getToken()}`",
    '   * })',
    '   */',
    '  headers?: HeadersInit;',
    '}',
    '',
    '/**',
    ' * Error thrown when an API request fails (non-2xx response).',
    ' */',
    'export class ApiError extends Error {',
    '  /** HTTP status code */',
    '  status: number;',
    '  /** HTTP status text */',
    '  statusText: string;',
    '  /** Parsed response body, if available */',
    '  body?: unknown;',
    '',
    '  constructor(status: number, statusText: string, body?: unknown) {',
    '    super(`HTTP ${status}: ${statusText}`);',
    '    this.name = "ApiError";',
    '    this.status = status;',
    '    this.statusText = statusText;',
    '    this.body = body;',
    '  }',
    '}',
    '',
    '/**',
    ` * Base class for all generated API clients.`,
    ' */',
    `export class Base${suffix} {`,
    '  protected config: ApiConfig;',
    '',
    '  constructor(config: ApiConfig) {',
    '    this.config = config;',
    '  }',
    '',
    '  /**',
    '   * Make an HTTP request to the API.',
    '   */',
    '  protected async request<T>(',
    '    method: string,',
    '    path: string,',
    '    options?: {',
    '      query?: Record<string, unknown>;',
    '      body?: unknown;',
    '      headers?: Record<string, string>;',
    '    },',
    '  ): Promise<T> {',
    '    // Build URL with query parameters',
    '    const url = new URL(path, this.config.baseUrl);',
    '',
    '    if (options?.query) {',
    '      for (const [key, value] of Object.entries(options.query)) {',
    '        if (value !== undefined && value !== null) {',
    '          url.searchParams.set(key, String(value));',
    '        }',
    '      }',
    '    }',
    '',
    '    // Resolve config headers (static, sync function, or async function)',
    '    const configHeaders: Record<string, string> =',
    "      typeof this.config.headers === 'function'",
    '        ? await this.config.headers()',
    '        : this.config.headers ?? {};',
    '',
    '    // Merge headers: config headers < per-request headers',
    '    const headers: Record<string, string> = {',
    '      ...configHeaders,',
    '      ...options?.headers,',
    '    };',
    '',
    '    // Add Content-Type for requests with body',
    '    if (options?.body !== undefined) {',
    "      headers['Content-Type'] = 'application/json';",
    '    }',
    '',
    '    // Make request',
    '    const response = await fetch(url.toString(), {',
    '      method,',
    '      headers,',
    '      body: options?.body !== undefined ? JSON.stringify(options.body) : undefined,',
    '    });',
    '',
    '    // Handle errors',
    '    if (!response.ok) {',
    '      let body: unknown;',
    '      try {',
    '        body = await response.json();',
    '      } catch {',
    '        // Ignore JSON parse errors for error responses',
    '      }',
    '      throw new ApiError(response.status, response.statusText, body);',
    '    }',
    '',
    '    // Handle empty responses (204 No Content)',
    '    if (response.status === 204) {',
    '      return undefined as T;',
    '    }',
    '',
    '    // Parse JSON response',
    '    return (await response.json()) as T;',
    '  }',
    '}',
    '',
  ];

  return lines.join('\n');
};
